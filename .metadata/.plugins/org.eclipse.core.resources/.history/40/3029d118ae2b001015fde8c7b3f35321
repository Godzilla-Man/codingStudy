<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>관리자 페이지</title>
<style>
	input[type=checkbox].chk + label {
		height : 24px;
	}
</style>
</head>
<body>
	<div class="wrap">
		<jsp:include page="/WEB-INF/views/common/header.jsp"></jsp:include>
		<main class="content">
			<section class="section admin-wrap">
				<div class="page-title">회원 관리 페이지</div>
				<table class="tbl tbl-hover">
					<tr>
						<th style="width:5%;">선택</th>
						<th style="width:5%;">번호</th>
						<th style="width:10%;">아이디</th>
						<th style="width:10%;">이름</th>
						<th style="width:15%;">이메일</th>
						<th style="width:15%;">전화번호</th>
						<th style="width:10%;">주소</th>
						<th style="width:10%;">가입일</th>
						<th style="width:10%;">등급</th>
						<th style="width:10%;">변경</th>
					</tr>
					<c:forEach var="m" items="${memberList}">
					<tr>
						<td>
							<div class="input-wrap">
								<input type="checkbox" class="chk">
								<label></label>
							</div>
						</td>
						<td class="memberNo">${m.memberNo}</td>
						<td>${m.memberId}</td>
						<td>${m.memberName}</td>
						<td>${m.memberEmail}</td>
						<td>${m.memberPhone}</td>
						<td>${m.memberAddr}</td>
						<td>${m.enrollDate}</td>
						<td>
							<div class="select">
								<select>
									<c:if test="${m.memberLevel eq 2}">
									<option value="2" selected>정회원</option>
									<option value="3">준회원</option>
									</c:if>
									<c:if test="${m.memberLevel eq 3}">
									<option value="2">정회원</option>
									<option value="3" selected>준회원</option>
									</c:if>
								</select>
							</div>
						</td>
						<td>
							<button class="btn-primary sm" onclick="chgLevel(this)">등급변경</button>
						</td>
					</tr>
					</c:forEach>
					
					<tr>
						<td colsapn="10">
							<button class="btn-point lg" onclick="chgAllLevel()">선택 회원 등급 변경</button>
						</td>
					</tr>
					
				</table>
			</section>
		</main>
		<jsp:include page="/WEB-INF/views/common/footer.jsp"></jsp:include>
	</div>
	<script>
	//각 행마다 생성된 '등급변경' 버튼 클릭 시, 동작 함수
	function chgLevel(btnObj){
		/*
		DAO에서 수행할 SQL : update tbl_member set member_level = ? where member_no = ?
		클라이언트가 서버로 전송해야 하는 값은 회원번호, 변경할 등급
		
		btnObj는 클릭한 버튼 요소 자바스크립트 객체		
		*/
		
		//let memberNo = $(btnObj).parent().parent().children().first().next().html();
		let memberNo = $(btnObj).parents('tr').find('.memberNo').html();
		let chgLevel = $(btnObj).parents('tr').find('select option:selected').val();
		
		swal({
			title : "변경",
			text : "등급을 변경하시겠습니까?",
			icon : "warning",
			buttons : {
				cancel : {
					text : "취소",
					value : false,
					visible : true,
					closeModal : true
				},
				confirm : {
					text : "변경",
					value : true,
					visible : true,
					closeModal : true
				}
			}
		}).then(function(val){
			if(val){ //변경 버튼 클릭 시
				
				$.ajax({
					url : "/member/chgLevel",
					data : {"memberNo" : memberNo, "chgLevel" : chgLevel},
					type : "get",
					success : function(res){
						console.log(res);
						//res : 서블릿에서 응답스트림을 통해, 전달한 값(업데이트 결과 값)
						if(res > 0){
							swal({
								title : "성공",
								text : "등급 변경이 완료되었습니다.",
								icon : "success""
							});
						}else{
							swal({
								title : "실패",
								text : "등급 변경 중, 오류가 발생하였습니다.",
								icon : "error"
							});
						}
					},
					error : function(){
						console.log('ajax 통신 오류');
					}
				})	
			}
		});			
	}
	</script>
</body>
</html>